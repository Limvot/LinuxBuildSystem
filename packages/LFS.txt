#Build step file for Linux Build System
# The @= as assignment allows = to be used in commands

NAME@=LinuxFromScratch

PROVIDES@=LFS linux man-pages zlib file binutils GMP MPFR MPC gcc sed bzip2 pkg-config ncurses util-linux psmisc procps-ng e2fsprogs shadow coreutils iana-etc M4 bison grep readline bash libtool GDBM ineutils perl autoconf automake diffutils gawk findutils flex gettext groff xz GRUB less gzip iproute2 kbd kmod libpipeline make man-DB patch sysklogd sysvinit tar texinfo udev vim

BUILD_STEP@=LFS_Download

ONLY_COMMANDS@=True

#Download all the source files

DOWNLOAD_PATH@=http://ftp.gnu.org/gnu/autoconf/autoconf-2.69.tar.xz
DOWNLOAD_PATH@=http://ftp.gnu.org/gnu/automake/automake-1.13.1.tar.xz
DOWNLOAD_PATH@=http://ftp.gnu.org/gnu/bash/bash-4.2.tar.gz
DOWNLOAD_PATH@=http://ftp.gnu.org/gnu/binutils/binutils-2.23.1.tar.bz2
DOWNLOAD_PATH@=http://ftp.gnu.org/gnu/bison/bison-2.7.tar.xz
DOWNLOAD_PATH@=http://www.bzip.org/1.0.6/bzip2-1.0.6.tar.gz
DOWNLOAD_PATH@=http://sourceforge.net/projects/check/files/check/0.9.9/check-0.9.9.tar.gz
DOWNLOAD_PATH@=http://ftp.gnu.org/gnu/coreutils/coreutils-8.20.tar.xz
DOWNLOAD_PATH@=http://ftp.gnu.org/gnu/dejagnu/dejagnu-1.5.tar.gz
DOWNLOAD_PATH@=http://ftp.gnu.org/gnu/diffutils/diffutils-3.2.tar.gz
DOWNLOAD_PATH@=http://prdownloads.sourceforge.net/e2fsprogs/e2fsprogs-1.42.7.tar.gz
DOWNLOAD_PATH@=http://prdownloads.sourceforge.net/expect/expect5.45.tar.gz
DOWNLOAD_PATH@=ftp://ftp.astron.com/pub/file/file-5.11.tar.gz
DOWNLOAD_PATH@=http://ftp.gnu.org/gnu/findutils/findutils-4.4.2.tar.gz
DOWNLOAD_PATH@=http://prdownloads.sourceforge.net/flex/flex-2.5.37.tar.bz2
DOWNLOAD_PATH@=http://ftp.gnu.org/gnu/gawk/gawk-4.0.2.tar.xz
DOWNLOAD_PATH@=http://ftp.gnu.org/gnu/gcc/gcc-4.7.2/gcc-4.7.2.tar.bz2
DOWNLOAD_PATH@=http://ftp.gnu.org/gnu/gdbm/gdbm-1.10.tar.gz
DOWNLOAD_PATH@=http://ftp.gnu.org/gnu/gettext/gettext-0.18.2.tar.gz
DOWNLOAD_PATH@=http://ftp.gnu.org/gnu/glibc/glibc-2.17.tar.xz
DOWNLOAD_PATH@=ftp://ftp.gmplib.org/pub/gmp-5.1.0/gmp-5.1.0.tar.xz
DOWNLOAD_PATH@=http://ftp.gnu.org/gnu/grep/grep-2.14.tar.xz
DOWNLOAD_PATH@=http://ftp.gnu.org/gnu/groff/groff-1.22.1.tar.gz
DOWNLOAD_PATH@=http://ftp.gnu.org/gnu/grub/grub-2.00.tar.xz
DOWNLOAD_PATH@=http://ftp.gnu.org/gnu/gzip/gzip-1.5.tar.xz
DOWNLOAD_PATH@=http://anduin.linuxfromscratch.org/sources/LFS/lfs-packages/conglomeration//iana-etc/iana-etc-2.30.tar.bz2
DOWNLOAD_PATH@=http://ftp.gnu.org/gnu/inetutils/inetutils-1.9.1.tar.gz
DOWNLOAD_PATH@=http://www.kernel.org/pub/linux/utils/net/iproute2/iproute2-3.7.0.tar.xz
DOWNLOAD_PATH@=http://ftp.altlinux.org/pub/people/legion/kbd/kbd-1.15.5.tar.gz
DOWNLOAD_PATH@=http://www.kernel.org/pub/linux/utils/kernel/kmod/kmod-12.tar.xz
DOWNLOAD_PATH@=http://www.greenwoodsoftware.com/less/less-451.tar.gz
DOWNLOAD_PATH@=http://www.linuxfromscratch.org/lfs/downloads/development/lfs-bootscripts-20130123.tar.bz2
DOWNLOAD_PATH@=http://download.savannah.gnu.org/releases/libpipeline/libpipeline-1.2.2.tar.gz
DOWNLOAD_PATH@=http://ftp.gnu.org/gnu/libtool/libtool-2.4.2.tar.gz
DOWNLOAD_PATH@=http://www.kernel.org/pub/linux/kernel/v3.x/linux-3.7.4.tar.xz
DOWNLOAD_PATH@=http://ftp.gnu.org/gnu/m4/m4-1.4.16.tar.bz2
DOWNLOAD_PATH@=http://ftp.gnu.org/gnu/make/make-3.82.tar.bz2
DOWNLOAD_PATH@=http://download.savannah.gnu.org/releases/man-db/man-db-2.6.3.tar.xz
DOWNLOAD_PATH@=http://www.kernel.org/pub/linux/docs/man-pages/man-pages-3.45.tar.xz
DOWNLOAD_PATH@=http://www.multiprecision.org/mpc/download/mpc-1.0.1.tar.gz
DOWNLOAD_PATH@=http://www.mpfr.org/mpfr-3.1.1/mpfr-3.1.1.tar.xz
DOWNLOAD_PATH@=ftp://ftp.gnu.org/gnu/ncurses/ncurses-5.9.tar.gz
DOWNLOAD_PATH@=http://ftp.gnu.org/gnu/patch/patch-2.7.1.tar.xz
DOWNLOAD_PATH@=http://www.cpan.org/src/5.0/perl-5.16.2.tar.bz2
DOWNLOAD_PATH@=http://pkgconfig.freedesktop.org/releases/pkg-config-0.28.tar.gz
DOWNLOAD_PATH@= http://sourceforge.net/projects/procps-ng/files/Production/procps-ng-3.3.6.tar.xz
DOWNLOAD_PATH@=http://prdownloads.sourceforge.net/psmisc/psmisc-22.20.tar.gz
DOWNLOAD_PATH@=http://ftp.gnu.org/gnu/readline/readline-6.2.tar.gz
DOWNLOAD_PATH@=http://ftp.gnu.org/gnu/sed/sed-4.2.2.tar.bz2
DOWNLOAD_PATH@=http://pkg-shadow.alioth.debian.org/releases/shadow-4.1.5.1.tar.bz2
DOWNLOAD_PATH@=http://www.infodrom.org/projects/sysklogd/download/sysklogd-1.5.tar.gz
DOWNLOAD_PATH@=http://download.savannah.gnu.org/releases/sysvinit/sysvinit-2.88dsf.tar.bz2
DOWNLOAD_PATH@=http://ftp.gnu.org/gnu/tar/tar-1.26.tar.bz2
DOWNLOAD_PATH@=http://prdownloads.sourceforge.net/tcl/tcl8.6.0-src.tar.gz
DOWNLOAD_PATH@=http://www.iana.org//time-zones/repository/releases/tzdata2012j.tar.gz
DOWNLOAD_PATH@=http://ftp.gnu.org/gnu/texinfo/texinfo-4.13a.tar.gz
DOWNLOAD_PATH@=http://www.freedesktop.org/software/systemd/systemd-196.tar.xz
DOWNLOAD_PATH@=http://anduin.linuxfromscratch.org/sources/other/udev-lfs-196-4.tar.bz2
DOWNLOAD_PATH@=http://www.kernel.org/pub/linux/utils/util-linux/v2.22/util-linux-2.22.2.tar.xz
DOWNLOAD_PATH@=ftp://ftp.vim.org/pub/vim/unix/vim-7.3.tar.bz2
DOWNLOAD_PATH@=http://tukaani.org/xz/xz-5.0.4.tar.xz
DOWNLOAD_PATH@=http://www.zlib.net/zlib-1.2.7.tar.bz2
DOWNLOAD_PATH@=http://www.linuxfromscratch.org/patches/lfs/development/bash-4.2-fixes-11.patch
DOWNLOAD_PATH@=http://www.linuxfromscratch.org/patches/lfs/development/binutils-2.23.1-testsuite_fix-1.patch
DOWNLOAD_PATH@=http://www.linuxfromscratch.org/patches/lfs/development/bzip2-1.0.6-install_docs-1.patch
DOWNLOAD_PATH@=http://www.linuxfromscratch.org/patches/lfs/development/coreutils-8.20-i18n-1.patch
DOWNLOAD_PATH@=ttp://www.linuxfromscratch.org/patches/lfs/development/coreutils-8.20-test_fixes-1.patch
DOWNLOAD_PATH@=http://www.linuxfromscratch.org/patches/lfs/development/flex-2.5.37-bison-2.6.1-1.patch
DOWNLOAD_PATH@=http://www.linuxfromscratch.org/patches/lfs/development/kbd-1.15.5-backspace-1.patch
DOWNLOAD_PATH@=http://www.linuxfromscratch.org/patches/lfs/development/make-3.82-upstream_fixes-3.patch
DOWNLOAD_PATH@=http://www.linuxfromscratch.org/patches/lfs/development/perl-5.16.2-libc-1.patch
DOWNLOAD_PATH@=http://www.linuxfromscratch.org/patches/lfs/development/readline-6.2-fixes-1.patch


#Also download wget so that the linuxbuildsystem can bootstrap itself inside the chroot or rebooted final environment.
#This is a diviation from LFS.
DOWNLOAD_PATH@=http://ftp.gnu.org/gnu/wget/wget-1.14.tar.xz

END_BUILD_STEP

BUILD_STEP@=Binutils_1

ARCHIVE_NAME@=binutils-2.23.1.tar.bz2

SETUP_EXTERNAL_BUILD_DIRECTORY

CONFIGURE_COMMAND@=../binutils-2.23.1/configure --prefix=/tools --with-sysroot=$LFS --with-lib-path=/tools/lib --target=$LFS_TGT --disable-nls --disable-werror

MAKE_COMMAND@=make -j4

BEGIN_COMMAND_BLOCK
case $(uname -m) in
  x86_64) mkdir -v /tools/lib && ln -sv lib /tools/lib64 ;;
esac
END_COMMAND_BLOCK

INSTALL_COMMAND@=make install

END_BUILD_STEP

#############################

BUILD_STEP@=GCC_1

ARCHIVE_NAME@=gcc-4.7.2.tar.bz2

BEGIN_COMMAND_BLOCK
tar -Jxf ../mpfr-3.1.1.tar.xz
mv -v mpfr-3.1.1 mpfr
tar -Jxf ../gmp-5.1.0.tar.xz
mv -v gmp-5.1.0 gmp
tar -zxf ../mpc-1.0.1.tar.gz
mv -v mpc-1.0.1 mpc
END_COMMAND_BLOCK

BEGIN_COMMAND_BLOCK
for file in \
 $(find gcc/config -name linux64.h -o -name linux.h -o -name sysv4.h)
do
  cp -uv $file{,.orig}
  sed -e 's@/lib\(64\)\?\(32\)\?/ld@/tools&@g' \
      -e 's@/usr@/tools@g' $file.orig > $file
  echo '
#undef STANDARD_STARTFILE_PREFIX_1
#undef STANDARD_STARTFILE_PREFIX_2
#define STANDARD_STARTFILE_PREFIX_1 "/tools/lib/"
#define STANDARD_STARTFILE_PREFIX_2 ""' >> $file
  touch $file.orig
done
END_COMMAND_BLOCK

BEGIN_COMMAND_BLOCK
sed -i '/k prot/agcc_cv_libc_provides_ssp=yes' gcc/configure
END_COMMAND_BLOCK


SETUP_EXTERNAL_BUILD_DIRECTORY


CONFIGURE_COMMAND@=../gcc-4.7.2/configure --target=$LFS_TGT --prefix=/tools --with-sysroot=$LFS --with-newlib --without-headers --with-local-prefix=/tools --with-native-system-header-dir=/tools/include --disable-nls --disable-shared --disable-multilib --disable-decimal-float --disable-threads --disable-libmudflap --disable-libssp --disable-libgomp --disable-libquadmath --enable-languages=c --with-mpfr-include=$(pwd)/../gcc-4.7.2/mpfr/src --with-mpfr-lib=$(pwd)/mpfr/src/.libs

MAKE_COMMAND@=make -j4


INSTALL_COMMAND@=make install

BEGIN_COMMAND_BLOCK
ln -sv libgcc.a `$LFS_TGT-gcc -print-libgcc-file-name | sed 's/libgcc/&_eh/'`
END_COMMAND_BLOCK

END_BUILD_STEP


#############################

BUILD_STEP@=Linux_API_Headers_1

ARCHIVE_NAME@=linux-3.7.4.tar.xz

MAKE_COMMAND@=make mrproper
MAKE_COMMAND@=make headers_check
MAKE_COMMAND@=make INSTALL_HDR_PATH=dest headers_install

BEGIN_COMMAND_BLOCK
cp -rv dest/include/* /tools/include
END_COMMAND_BLOCK

END_BUILD_STEP

#############################

BUILD_STEP@=Glibc_1

ARCHIVE_NAME@=glibc-2.17.tar.xz

BEGIN_COMMAND_BLOCK
if [ ! -r /usr/include/rpc/types.h ]; then 
  su -c 'mkdir -p /usr/include/rpc'
  su -c 'cp -v sunrpc/rpc/*.h /usr/include/rpc'
fi
END_COMMAND_BLOCK

SETUP_EXTERNAL_BUILD_DIRECTORY

CONFIGURE_COMMAND@=../glibc-2.17/configure --prefix=/tools --host=$LFS_TGT --build=$(../glibc-2.17/scripts/config.guess) --disable-profile --enable-kernel=2.6.25 --with-headers=/tools/include libc_cv_forced_unwind=yes libc_cv_ctors_header=yes libc_cv_c_cleanup=yes

MAKE_COMMAND@=make -j4

INSTALL_COMMAND@=make install

BEGIN_COMMAND_BLOCK
echo 'main(){}' > dummy.c
$LFS_TGT-gcc dummy.c
readelf -l a.out | grep ': /tools'
END_COMMAND_BLOCK

END_BUILD_STEP

#############################


BUILD_STEP@=Binutils_2

ARCHIVE_NAME@=binutils-2.23.1.tar.bz2

SETUP_EXTERNAL_BUILD_DIRECTORY

CONFIGURE_COMMAND@=CC=$LFS_TGT-gcc AR=$LFS_TGT-ar RANLIB=$LFS_TGT-ranlib ../binutils-2.23.1/configure --prefix=/tools --disable-nls --with-lib-path=/tools/lib

MAKE_COMMAND@=make -j4

INSTALL_COMMAND@=make install

BEGIN_COMMAND_BLOCK
make -C ld clean
make -C ld LIB_PATH=/usr/lib:/lib
cp -v ld/ld-new /tools/bin
END_COMMAND_BLOCK

END_BUILD_STEP

#############################

BUILD_STEP@=GCC_2

ARCHIVE_NAME@=gcc-4.7.2.tar.bz2

BEGIN_COMMAND_BLOCK
cat gcc/limitx.h gcc/glimits.h gcc/limity.h > `dirname $($LFS_TGT-gcc -print-libgcc-file-name)`/include-fixed/limits.h
END_COMMAND_BLOCK

BEGIN_COMMAND_BLOCK
cp -v gcc/Makefile.in{,.tmp}
sed 's/^T_CFLAGS =$/& -fomit-frame-pointer/' gcc/Makefile.in.tmp > gcc/Makefile.in
END_COMMAND_BLOCK


BEGIN_COMMAND_BLOCK
for file in $(find gcc/config -name linux64.h -o -name linux.h -o -name sysv4.h)
do
  cp -uv $file{,.orig}
  sed -e 's@/lib\(64\)\?\(32\)\?/ld@/tools&@g' -e 's@/usr@/tools@g' $file.orig > $file
  echo '
#undef STANDARD_STARTFILE_PREFIX_1
#undef STANDARD_STARTFILE_PREFIX_2
#define STANDARD_STARTFILE_PREFIX_1 "/tools/lib/"
#define STANDARD_STARTFILE_PREFIX_2 ""' >> $file
  touch $file.orig
done
END_COMMAND_BLOCK


BEGIN_COMMAND_BLOCK
tar -Jxf ../mpfr-3.1.1.tar.xz
mv -v mpfr-3.1.1 mpfr
tar -Jxf ../gmp-5.1.0.tar.xz
mv -v gmp-5.1.0 gmp
tar -zxf ../mpc-1.0.1.tar.gz
mv -v mpc-1.0.1 mpc
END_COMMAND_BLOCK


SETUP_EXTERNAL_BUILD_DIRECTORY


CONFIGURE_COMMAND@=CC=$LFS_TGT-gcc AR=$LFS_TGT-ar RANLIB=$LFS_TGT-ranlib ../gcc-4.7.2/configure --prefix=/tools --with-local-prefix=/tools --with-native-system-header-dir=/tools/include --enable-clocale=gnu --enable-shared --enable-threads=posix --enable-__cxa_atexit --enable-languages=c,c++ --disable-libstdcxx-pch --disable-multilib --disable-bootstrap --disable-libgomp --with-mpfr-include=$(pwd)/../gcc-4.7.2/mpfr/src --with-mpfr-lib=$(pwd)/mpfr/src/.libs

MAKE_COMMAND@=make -j4


INSTALL_COMMAND@=make install

BEGIN_COMMAND_BLOCK
ln -sv gcc /tools/bin/cc
END_COMMAND_BLOCK

BEGIN_COMMAND_BLOCK
echo 'main(){}' > dummy.c
cc dummy.c
readelf -l a.out | grep ': /tools'
END_COMMAND_BLOCK

END_BUILD_STEP


#############################

BUILD_STEP@=Tcl_1

ARCHIVE_NAME@=tcl8.6.0-src.tar.gz

BEGIN_COMMAND_BLOCK
cd tcl8.6.0
cd unix
END_COMMAND_BLOCK

CONFIGURE_COMMAND@=./configure --prefix=/tools

MAKE_COMMAND@=make -j4

INSTALL_COMMAND@=make install

BEGIN_COMMAND_BLOCK
chmod -v u+w /tools/lib/libtcl8.6.so
END_COMMAND_BLOCK


INSTALL_COMMAND@=make install-private-headers

BEGIN_COMMAND_BLOCK
ln -sv tclsh8.6 /tools/bin/tclsh
cd ../..
rm -r tcl8.6.0
END_COMMAND_BLOCK

END_BUILD_STEP

#############################

BUILD_STEP@=Expect_1

ARCHIVE_NAME@=expect5.45.tar.gz

BEGIN_COMMAND_BLOCK
cp -v configure{,.orig}
sed 's:/usr/local/bin:/bin:' configure.orig > configure
END_COMMAND_BLOCK

CONFIGURE_COMMAND@=./configure --prefix=/tools --with-tcl=/tools/lib --with-tclinclude=/tools/include

MAKE_COMMAND@=make -j4

INSTALL_COMMAND@=make SCRIPTS="" install

END_BUILD_STEP

#############################

BUILD_STEP@=DejaGNU_1

ARCHIVE_NAME@=dejagnu-1.5.tar.gz


CONFIGURE_COMMAND@=./configure --prefix=/tools

INSTALL_COMMAND@=make install

END_BUILD_STEP

#############################

BUILD_STEP@=Ncurses_1

ARCHIVE_NAME@=ncurses-5.9.tar.gz


CONFIGURE_COMMAND@=./configure --prefix=/tools --with-shared --without-debug --without-ada --enable-overwrite

MAKE_COMMAND@=make -j4

INSTALL_COMMAND@=make install

END_BUILD_STEP

#############################

BUILD_STEP@=Bash_1

ARCHIVE_NAME@=bash-4.2.tar.gz

BEGIN_COMMAND_BLOCK
patch -Np1 -i ../bash-4.2-fixes-11.patch
END_COMMAND_BLOCK


CONFIGURE_COMMAND@=./configure --prefix=/tools --without-bash-malloc

MAKE_COMMAND@=make -j4

INSTALL_COMMAND@=make install

BEGIN_COMMAND_BLOCK
ln -sv bash /tools/bin/sh
END_COMMAND_BLOCK

END_BUILD_STEP

#############################

BUILD_STEP@=Bzip2_1

ARCHIVE_NAME@=bzip2-1.0.6.tar.gz

MAKE_COMMAND@=make -j4

INSTALL_COMMAND@=make PREFIX=/tools install

END_BUILD_STEP

#############################

BUILD_STEP@=Coreutils_1

ARCHIVE_NAME@=coreutils-8.20.tar.xz

CONFIGURE_COMMAND@=./configure --prefix=/tools --enable-install-program=hostname

MAKE_COMMAND@=make -j4

INSTALL_COMMAND@=make install

END_BUILD_STEP

#############################

BUILD_STEP@=Diffutils_1

ARCHIVE_NAME@=diffutils-3.2.tar.gz

BEGIN_COMMAND_BLOCK
sed -i -e '/gets is a/d' lib/stdio.in.h
END_COMMAND_BLOCK

CONFIGURE_COMMAND@=./configure --prefix=/tools

MAKE_COMMAND@=make -j4

INSTALL_COMMAND@=make install

END_BUILD_STEP

#############################

BUILD_STEP@=File_1

ARCHIVE_NAME@=file-5.11.tar.gz


CONFIGURE_COMMAND@=./configure --prefix=/tools

MAKE_COMMAND@=make -j4

INSTALL_COMMAND@=make install

END_BUILD_STEP

#############################

BUILD_STEP@=Findutils_1

ARCHIVE_NAME@=findutils-4.4.2.tar.gz


CONFIGURE_COMMAND@=./configure --prefix=/tools

MAKE_COMMAND@=make -j4

INSTALL_COMMAND@=make install

END_BUILD_STEP

#############################

BUILD_STEP@=Gawk_1

ARCHIVE_NAME@=gawk-4.0.2.tar.xz


CONFIGURE_COMMAND@=./configure --prefix=/tools

MAKE_COMMAND@=make -j4

INSTALL_COMMAND@=make install

END_BUILD_STEP

#############################

BUILD_STEP@=Gettext_1

ARCHIVE_NAME@=gettext-0.18.2.tar.gz

BEGIN_COMMAND_BLOCK
cd gettext-tools
END_COMMAND_BLOCK

CONFIGURE_COMMAND@=EMACS="no" ./configure --prefix=/tools --disable-shared

BEGIN_COMMAND_BLOCK
make -C gnulib-lib
make -C src msgfmt
END_COMMAND_BLOCK

BEGIN_COMMAND_BLOCK
cp -v src/msgfmt /tools/bin
END_COMMAND_BLOCK


END_BUILD_STEP

#############################

BUILD_STEP@=Grep_1

ARCHIVE_NAME@=grep-2.14.tar.xz


CONFIGURE_COMMAND@=./configure --prefix=/tools

MAKE_COMMAND@=make -j4

INSTALL_COMMAND@=make install

END_BUILD_STEP

#############################

BUILD_STEP@=Gzip_1

ARCHIVE_NAME@=gzip-1.5.tar.xz


CONFIGURE_COMMAND@=./configure --prefix=/tools

MAKE_COMMAND@=make -j4

INSTALL_COMMAND@=make install

END_BUILD_STEP

#############################

BUILD_STEP@=M4_1

ARCHIVE_NAME@=m4-1.4.16.tar.bz2

BEGIN_COMMAND_BLOCK
sed -i -e '/gets is a/d' lib/stdio.in.h
END_COMMAND_BLOCK

CONFIGURE_COMMAND@=./configure --prefix=/tools

MAKE_COMMAND@=make -j4

INSTALL_COMMAND@=make install

END_BUILD_STEP

#############################

BUILD_STEP@=Make_1

ARCHIVE_NAME@=make-3.82.tar.bz2

CONFIGURE_COMMAND@=./configure --prefix=/tools

MAKE_COMMAND@=make -j4

INSTALL_COMMAND@=make install

END_BUILD_STEP

#############################

BUILD_STEP@=Patch_1

ARCHIVE_NAME@=patch-2.7.1.tar.xz

CONFIGURE_COMMAND@=./configure --prefix=/tools

MAKE_COMMAND@=make -j4

INSTALL_COMMAND@=make install

END_BUILD_STEP

#############################

BUILD_STEP@=Perl_1

ARCHIVE_NAME@=perl-5.16.2.tar.bz2

BEGIN_COMMAND_BLOCK
patch -Np1 -i ../perl-5.16.2-libc-1.patch
END_COMMAND_BLOCK

CONFIGURE_COMMAND@=sh Configure -des -Dprefix=/tools

MAKE_COMMAND@=make -j4

BEGIN_COMMAND_BLOCK
cp -v perl cpan/podlators/pod2man /tools/bin
mkdir -pv /tools/lib/perl5/5.16.2
cp -Rv lib/* /tools/lib/perl5/5.16.2
END_COMMAND_BLOCK

END_BUILD_STEP

#############################

BUILD_STEP@=Sed_1

ARCHIVE_NAME@=sed-4.2.2.tar.bz2

CONFIGURE_COMMAND@=./configure --prefix=/tools

MAKE_COMMAND@=make -j4

INSTALL_COMMAND@=make install

END_BUILD_STEP

#############################

BUILD_STEP@=Tar_1

ARCHIVE_NAME@=tar-1.26.tar.bz2

BEGIN_COMMAND_BLOCK
sed -i -e '/gets is a/d' gnu/stdio.in.h
END_COMMAND_BLOCK

CONFIGURE_COMMAND@=./configure --prefix=/tools

MAKE_COMMAND@=make -j4

INSTALL_COMMAND@=make install

END_BUILD_STEP

#############################

BUILD_STEP@=Texinfo_1

ARCHIVE_NAME@=texinfo-4.13a.tar.gz

BEGIN_COMMAND_BLOCK
cd texinfo-4.13
END_COMMAND_BLOCK

CONFIGURE_COMMAND@=./configure --prefix=/tools

MAKE_COMMAND@=make -j4

INSTALL_COMMAND@=make install

BEGIN_COMMAND_BLOCK
cd ..
rm -rf texinfo-4.13
END_COMMAND_BLOCK

END_BUILD_STEP

#############################

BUILD_STEP@=Xz_1

ARCHIVE_NAME@=xz-5.0.4.tar.xz

CONFIGURE_COMMAND@=./configure --prefix=/tools

MAKE_COMMAND@=make -j4

INSTALL_COMMAND@=make install

END_BUILD_STEP

#############################
#Get errors when run, so commented out

#BUILD_STEP@=Stripping_1
#
#ONLY_COMMANDS@=True
#
#BEGIN_COMMAND_BLOCK
#strip --strip-debug /tools/lib/*
#strip --strip-unneeded /tools/{,s}bin/*
#END_COMMAND_BLOCK
#
#END_BUILD_STEP

#############################

#Requires permissions we do not have. Left up to the user to do
#
#BUILD_STEP@=ChangeOwnership_1
#
#ONLY_COMMANDS@=True
#
#BEGIN_COMMAND_BLOCK
#cd ..
#chown -R root:root tools
#END_COMMAND_BLOCK
#
#END_BUILD_STEP
#
##############################

BUILD_STEP@=BackupTools_1

ONLY_COMMANDS@=True

BEGIN_COMMAND_BLOCK
cd ..
tar -pczf tools.tar.gz tools
END_COMMAND_BLOCK

END_BUILD_STEP

#############################

#Some of the steps here require root, which is an interesting problem.
#Solution used here is to just create a script that the user should run as root, and then have the user run the rest of the scripts 

BUILD_STEP@=PrepVirtKernelFileSystems_1

ONLY_COMMANDS@=True

BEGIN_COMMAND_BLOCK
#get to base dir
cd ..

#create the script to finish the build after the root and chroot stuff
python3 $LBS_PROGRAM LFS 32 $LBS_END_STEP / AfterPrepVirtKernelFileSystems_1_ResumeBuild.sh --omit-tests
END_COMMAND_BLOCK

#If we didn't omit tests, redo the command with --omit-tests removed
TEST@=python3 $LBS_PROGRAM LFS 32 $LBS_END_STEP / AfterPrepVirtKernelFileSystems_1_ResumeBuild.sh

BEGIN_COMMAND_BLOCK
chmod 755 AfterPrepVirtKernelFileSystems_1_ResumeBuild.sh

#create the script that will be run as root
cat > ./run_as_root.sh << "EOF"
mkdir -v ./{dev,proc,sys}

mknod -m 600 ./dev/console c 5 1
mknod -m 666 ./dev/null c 1 3

mount -v --bind /dev ./dev

mount -vt devpts devpts ./dev/pts
mount -vt proc proc ./proc
mount -vt sysfs sysfs ./sys

if [ -h /dev/shm ]; then
   rm -f ./dev/shm
   mkdir ./dev/shm
fi

mount -vt tmpfs shm ./dev/shm

#We chroot and resume the build
chroot "." /tools/bin/env -i HOME=/root TERM="$TERM" PS1='\u:\w\$ ' PATH=/bin:/usr/bin:/sbin:/usr/sbin:/tools/bin /tools/bin/bash --login +h AfterPrepVirtKernelFileSystems_1_ResumeBuild.sh

EOF

chmod 755 ./run_as_root.sh
su -c ./run_as_root.sh

#Quit the script because it should't run the next steps
exit;

END_COMMAND_BLOCK

END_BUILD_STEP

#############################

BUILD_STEP@=CreatingDirectories

ONLY_COMMANDS@=True

BEGIN_COMMAND_BLOCK
cd ..
mkdir -pv /{bin,boot,etc/{opt,sysconfig},home,lib,mnt,opt,run}
mkdir -pv /{media/{floppy,cdrom},sbin,srv,var}
install -dv -m 0750 /root
install -dv -m 1777 /tmp /var/tmp
mkdir -pv /usr/{,local/}{bin,include,lib,sbin,src}
mkdir -pv /usr/{,local/}share/{doc,info,locale,man}
mkdir -v  /usr/{,local/}share/{misc,terminfo,zoneinfo}
mkdir -pv /usr/{,local/}share/man/man{1..8}
for dir in /usr /usr/local; do
  ln -sv share/{man,doc,info} $dir
done
case $(uname -m) in
 x86_64) ln -sv lib /lib64 && ln -sv lib /usr/lib64 ;;
esac
mkdir -v /var/{log,mail,spool}
ln -sv /run /var/run
ln -sv /run/lock /var/lock
mkdir -pv /var/{opt,cache,lib/{misc,locate},local}
END_COMMAND_BLOCK

END_BUILD_STEP

#############################

BUILD_STEP@=CreatingEssentialFilesAndSymlinks

ONLY_COMMANDS@=True

BEGIN_COMMAND_BLOCK
cd ..
ln -sv /tools/bin/{bash,cat,echo,pwd,stty} /bin
ln -sv /tools/bin/perl /usr/bin
ln -sv /tools/lib/libgcc_s.so{,.1} /usr/lib
ln -sv /tools/lib/libstdc++.so{,.6} /usr/lib
sed 's/tools/usr/' /tools/lib/libstdc++.la > /usr/lib/libstdc++.la
ln -sv bash /bin/sh

touch /etc/mtab

cat > /etc/passwd << "EOF"
root:x:0:0:root:/root:/bin/bash
bin:x:1:1:bin:/dev/null:/bin/false
nobody:x:99:99:Unprivileged User:/dev/null:/bin/false
EOF

cat > /etc/group << "EOF"
root:x:0:
bin:x:1:
sys:x:2:
kmem:x:3:
tape:x:4:
tty:x:5:
daemon:x:6:
floppy:x:7:
disk:x:8:
lp:x:9:
dialout:x:10:
audio:x:11:
video:x:12:
utmp:x:13:
usb:x:14:
cdrom:x:15:
mail:x:34:
nogroup:x:99:
EOF

touch /var/log/{btmp,lastlog,wtmp}
chgrp -v utmp /var/log/lastlog
chmod -v 664  /var/log/lastlog
chmod -v 600  /var/log/btmp

END_COMMAND_BLOCK

END_BUILD_STEP

#############################

BUILD_STEP@=Linux_API_Headers_2

ARCHIVE_NAME@=linux-3.7.4.tar.xz

BEGIN_COMMAND_BLOCK
make mrproper
END_COMMAND_BLOCK

MAKE_COMMAND@=make headers_check

INSTALL_COMMAND@=make INSTALL_HDR_PATH=dest headers_install

BEGIN_COMMAND_BLOCK
find dest/include \( -name .install -o -name ..install.cmd \) -delete
cp -rv dest/include/* /usr/include
END_COMMAND_BLOCK

END_BUILD_STEP

#############################

BUILD_STEP@=Man_Pages_1

ARCHIVE_NAME@=man-pages-3.45.tar.xz

INSTALL_COMMAND@=make install

END_BUILD_STEP

#############################

BUILD_STEP@=Glibc_2

ARCHIVE_NAME@=glibc-2.17.tar.xz

SETUP_EXTERNAL_BUILD_DIRECTORY

CONFIGURE_COMMAND@=../glibc-2.17/configure --prefix=/usr --disable-profile  --enable-kernel=2.6.25 --libexecdir=/usr/lib/glibc

MAKE_COMMAND@=make -j4

TEST@=make -k check 2>&1 | tee glibc-check-log
TEST@=grep Error glibc-check-log

BEGIN_COMMAND_BLOCK
touch /etc/ld.so.conf
END_COMMAND_BLOCK

INSTALL_COMMAND@=make install

BEGIN_COMMAND_BLOCK
cp -v ../glibc-2.17/sunrpc/rpc/*.h /usr/include/rpc
cp -v ../glibc-2.17/sunrpc/rpcsvc/*.h /usr/include/rpcsvc
cp -v ../glibc-2.17/nis/rpcsvc/*.h /usr/include/rpcsvc

mkdir -pv /usr/lib/locale
localedef -i cs_CZ -f UTF-8 cs_CZ.UTF-8
localedef -i de_DE -f ISO-8859-1 de_DE
localedef -i de_DE@euro -f ISO-8859-15 de_DE@euro
localedef -i de_DE -f UTF-8 de_DE.UTF-8
localedef -i en_GB -f UTF-8 en_GB.UTF-8
localedef -i en_HK -f ISO-8859-1 en_HK
localedef -i en_PH -f ISO-8859-1 en_PH
localedef -i en_US -f ISO-8859-1 en_US
localedef -i en_US -f UTF-8 en_US.UTF-8
localedef -i es_MX -f ISO-8859-1 es_MX
localedef -i fa_IR -f UTF-8 fa_IR
localedef -i fr_FR -f ISO-8859-1 fr_FR
localedef -i fr_FR@euro -f ISO-8859-15 fr_FR@euro
localedef -i fr_FR -f UTF-8 fr_FR.UTF-8
localedef -i it_IT -f ISO-8859-1 it_IT
localedef -i it_IT -f UTF-8 it_IT.UTF-8
localedef -i ja_JP -f EUC-JP ja_JP
localedef -i ru_RU -f KOI8-R ru_RU.KOI8-R
localedef -i ru_RU -f UTF-8 ru_RU.UTF-8
localedef -i tr_TR -f UTF-8 tr_TR.UTF-8
localedef -i zh_CN -f GB18030 zh_CN.GB18030
END_COMMAND_BLOCK

MAKE_COMMAND@=make localedata/install-locales

BEGIN_COMMAND_BLOCK
cat > /etc/nsswitch.conf << "EOF"
# Begin /etc/nsswitch.conf

passwd: files
group: files
shadow: files

hosts: files dns
networks: files

protocols: files
services: files
ethers: files
rpc: files

# End /etc/nsswitch.conf
EOF


tar -xf ../tzdata2012j.tar.gz

ZONEINFO=/usr/share/zoneinfo
mkdir -pv $ZONEINFO/{posix,right} 

for tz in etcetera southamerica northamerica europe africa antarctica  \
          asia australasia backward pacificnew solar87 solar88 solar89 \
          systemv; do
    zic -L /dev/null   -d $ZONEINFO       -y "sh yearistype.sh" ${tz} 
    zic -L /dev/null   -d $ZONEINFO/posix -y "sh yearistype.sh" ${tz} 
    zic -L leapseconds -d $ZONEINFO/right -y "sh yearistype.sh" ${tz}
done

cp -v zone.tab iso3166.tab $ZONEINFO
zic -d $ZONEINFO -p America/New_York
unset ZONEINFO

cp -v --remove-destination /usr/share/zoneinfo/America/New_York /etc/localtime


cat > /etc/ld.so.conf << "EOF"
# Begin /etc/ld.so.conf
/usr/local/lib
/opt/lib

EOF

cat >> /etc/ld.so.conf << "EOF"
# Add an include directory
include /etc/ld.so.conf.d/*.conf

EOF
mkdir /etc/ld.so.conf.d

END_COMMAND_BLOCK

END_BUILD_STEP

#############################

BUILD_STEP@=AdjustingTheToolchain

ONLY_COMMANDS@=True

BEGIN_COMMAND_BLOCK
cd ..
mv -v /tools/bin/{ld,ld-old}
mv -v /tools/$(gcc -dumpmachine)/bin/{ld,ld-old}
mv -v /tools/bin/{ld-new,ld}
ln -sv /tools/bin/ld /tools/$(gcc -dumpmachine)/bin/ld

gcc -dumpspecs | sed -e 's@/tools@@g' \
    -e '/\*startfile_prefix_spec:/{n;s@.*@/usr/lib/ @}' \
    -e '/\*cpp:/{n;s@$@ -isystem /usr/include@}' > \
    `dirname $(gcc --print-libgcc-file-name)`/specs


echo 'main(){}' > dummy.c
cc dummy.c -v -Wl,--verbose &> dummy.log
readelf -l a.out | grep ': /lib'

grep -o '/usr/lib.*/crt[1in].*succeeded' dummy.log

grep -B1 '^ /usr/include' dummy.log

grep 'SEARCH.*/usr/lib' dummy.log |sed 's|; |\n|g'

grep "/lib.*/libc.so.6 " dummy.log

grep found dummy.log

rm -v dummy.c a.out dummy.log
END_COMMAND_BLOCK

END_BUILD_STEP

#############################

BUILD_STEP@=Zlib_2

ARCHIVE_NAME@=zlib-1.2.7.tar.bz2

CONFIGURE_COMMAND@=./configure --prefix=/usr

MAKE_COMMAND@=make -j4

INSTALL_COMMAND@=make install

BEGIN_COMMAND_BLOCK
mv -v /usr/lib/libz.so.* /lib
ln -sfv ../../lib/libz.so.1.2.7 /usr/lib/libz.so
END_COMMAND_BLOCK

END_BUILD_STEP

#############################

BUILD_STEP@=File_2

ARCHIVE_NAME@=file-5.11.tar.gz

CONFIGURE_COMMAND@=./configure --prefix=/usr

MAKE_COMMAND@=make -j4

INSTALL_COMMAND@=make install

END_BUILD_STEP

#############################

BUILD_STEP@=Binutils_3

ARCHIVE_NAME@=binutils-2.23.1.tar.bz2

BEGIN_COMMAND_BLOCK
rm -fv etc/standards.info
sed -i.bak '/^INFO/s/standards.info //' etc/Makefile.in

patch -Np1 -i ../binutils-2.23.1-testsuite_fix-1.patch
END_COMMAND_BLOCK

SETUP_EXTERNAL_BUILD_DIRECTORY

CONFIGURE_COMMAND@=../binutils-2.23.1/configure --prefix=/usr --enable-shared

MAKE_COMMAND@=make tooldir=/usr

TEST@=make -k check

INSTALL_COMMAND@=make tooldir=/usr install

BEGIN_COMMAND_BLOCK
cp -v ../binutils-2.23.1/include/libiberty.h /usr/include
END_COMMAND_BLOCK

END_BUILD_STEP

#############################

BUILD_STEP@=GMP_1

ARCHIVE_NAME@=gmp-5.1.0.tar.xz


CONFIGURE_COMMAND@=./configure --prefix=/usr --enable-cxx --enable-mpbsd

MAKE_COMMAND@=make -j4

TEST@=make check 2>&1 | tee gmp-check-log
TEST@=awk '/tests passed/{total+=$2} ; END{print total}' gmp-check-log

INSTALL_COMMAND@=make install

END_BUILD_STEP

#############################

BUILD_STEP@=MPFR_1

ARCHIVE_NAME@=mpfr-3.1.1.tar.xz


CONFIGURE_COMMAND@=./configure  --prefix=/usr --enable-thread-safe --docdir=/usr/share/doc/mpfr-3.1.1

MAKE_COMMAND@=make -j4

TEST@=make check

INSTALL_COMMAND@=make install
INSTALL_COMMAND@=make html
INSTALL_COMMAND@=make install-html

END_BUILD_STEP

#############################

BUILD_STEP@=MPC_1

ARCHIVE_NAME@=mpc-1.0.1.tar.gz


CONFIGURE_COMMAND@=./configure --prefix=/usr

MAKE_COMMAND@=make -j4

TEST@=make check

INSTALL_COMMAND@=make install

END_BUILD_STEP

#############################

BUILD_STEP@=GCC_3

ARCHIVE_NAME@=gcc-4.7.2.tar.bz2

BEGIN_COMMAND_BLOCK
sed -i 's/install_to_$(INSTALL_DEST) //' libiberty/Makefile.in

case `uname -m` in
  i?86) sed -i 's/^T_CFLAGS =$/& -fomit-frame-pointer/' gcc/Makefile.in ;;
esac

sed -i -e /autogen/d -e /check.sh/d fixincludes/Makefile.in
END_COMMAND_BLOCK

SETUP_EXTERNAL_BUILD_DIRECTORY

CONFIGURE_COMMAND@=../gcc-4.7.2/configure --prefix=/usr --libexecdir=/usr/lib --enable-shared --enable-threads=posix   --enable-__cxa_atexit --enable-clocale=gnu --enable-languages=c,c++ --disable-multilib --disable-bootstrap --with-system-zlib

MAKE_COMMAND@=make -j4

TEST@=ulimit -s 32768
TEST@=make -k check
TEST@=../gcc-4.7.2/contrib/test_summary

INSTALL_COMMAND@=make install

BEGIN_COMMAND_BLOCK
ln -sv ../usr/bin/cpp /lib
ln -sv gcc /usr/bin/cc

echo 'main(){}' > dummy.c
cc dummy.c -v -Wl,--verbose &> dummy.log
readelf -l a.out | grep ': /lib'

grep -o '/usr/lib.*/crt[1in].*succeeded' dummy.log

grep -B4 '^ /usr/include' dummy.log

grep 'SEARCH.*/usr/lib' dummy.log |sed 's|; |\n|g'

grep "/lib.*/libc.so.6 " dummy.log

grep found dummy.log

rm -v dummy.c a.out dummy.log

mkdir -pv /usr/share/gdb/auto-load/usr/lib
mv -v /usr/lib/*gdb.py /usr/share/gdb/auto-load/usr/lib

END_COMMAND_BLOCK

END_BUILD_STEP

#############################

BUILD_STEP@=Sed

ARCHIVE_NAME@=sed-4.2.2.tar.bz2

CONFIGURE_COMMAND@=./configure --prefix=/usr --bindir=/bin --htmldir=/usr/share/doc/sed-4.2.2

MAKE_COMMAND@=make -j4
MAKE_COMMAND@=make html

TEST@=make check

INSTALL_COMMAND@=make install
INSTALL_COMMAND@=make -C doc install-html

END_BUILD_STEP

#############################

BUILD_STEP@=Bzip2_2

ARCHIVE_NAME@=bzip2-1.0.6.tar.gz

BEGIN_COMMAND_BLOCK
patch -Np1 -i ../bzip2-1.0.6-install_docs-1.patch

sed -i 's@\(ln -s -f \)$(PREFIX)/bin/@\1@' Makefile

sed -i "s@(PREFIX)/man@(PREFIX)/share/man@g" Makefile
END_COMMAND_BLOCK

CONFIGURE_COMMAND@=make -f Makefile-libbz2_so

MAKE_COMMAND@=make clean
MAKE_COMMAND@=make -j4

INSTALL_COMMAND@=make PREFIX=/usr install

BEGIN_COMMAND_BLOCK
cp -v bzip2-shared /bin/bzip2
cp -av libbz2.so* /lib
ln -sv ../../lib/libbz2.so.1.0 /usr/lib/libbz2.so
rm -v /usr/bin/{bunzip2,bzcat,bzip2}
ln -sv bzip2 /bin/bunzip2
ln -sv bzip2 /bin/bzcat
END_COMMAND_BLOCK

END_BUILD_STEP

#############################

BUILD_STEP@=Pkg_config

ARCHIVE_NAME@=pkg-config-0.28.tar.gz

CONFIGURE_COMMAND@=./configure --prefix=/usr --with-internal-glib --disable-host-tool --docdir=/usr/share/doc/pkg-config-0.28

MAKE_COMMAND@=make -j4

TEST@=make check

INSTALL_COMMAND@=make install

END_BUILD_STEP

#############################

BUILD_STEP@=Ncurses_2

ARCHIVE_NAME@=ncurses-5.9.tar.gz

CONFIGURE_COMMAND@=./configure --prefix=/usr --mandir=/usr/share/man --with-shared --without-debug --enable-widec

MAKE_COMMAND@=make -j4

INSTALL_COMMAND@=make install

BEGIN_COMMAND_BLOCK
mv -v /usr/lib/libncursesw.so.5* /lib

ln -sfv ../../lib/libncursesw.so.5 /usr/lib/libncursesw.so

for lib in ncurses form panel menu ; do 
    rm -vf /usr/lib/lib${lib}.so 
    echo "INPUT(-l${lib}w)" >/usr/lib/lib${lib}.so
    ln -sfv lib${lib}w.a /usr/lib/lib${lib}.a
done

ln -sfv libncurses++w.a /usr/lib/libncurses++.a

rm -vf                     /usr/lib/libcursesw.so
echo "INPUT(-lncursesw)" > /usr/lib/libcursesw.so
ln -sfv libncurses.so      /usr/lib/libcurses.so
ln -sfv libncursesw.a      /usr/lib/libcursesw.a
ln -sfv libncurses.a       /usr/lib/libcurses.a

mkdir -v       /usr/share/doc/ncurses-5.9
cp -v -R doc/* /usr/share/doc/ncurses-5.9

END_COMMAND_BLOCK

BEGIN_COMMAND_BLOCK
#These command rebuild the library with non-wide-characters for binary applications and to be complient with LSB

make distclean
./configure --prefix=/usr --with-shared --without-normal --without-debug --without-cxx-binding
make sources libs
cp -av lib/lib*.so.5* /usr/lib

END_COMMAND_BLOCK


END_BUILD_STEP

#############################

BUILD_STEP@=Util_linux_2

ARCHIVE_NAME@=util-linux-2.22.2.tar.xz

BEGIN_COMMAND_BLOCK
sed -i -e 's@etc/adjtime@var/lib/hwclock/adjtime@g' $(grep -rl '/etc/adjtime' .)

mkdir -pv /var/lib/hwclock
END_COMMAND_BLOCK

CONFIGURE_COMMAND@=./configure --disable-su --disable-sulogin --disable-login

MAKE_COMMAND@=make -j4

INSTALL_COMMAND@=make install

END_BUILD_STEP

#############################

BUILD_STEP@=Psmisc_2

ARCHIVE_NAME@=psmisc-22.20.tar.gz

CONFIGURE_COMMAND@=./configure --prefix=/usr

MAKE_COMMAND@=make -j4

INSTALL_COMMAND@=make install

BEGIN_COMMAND_BLOCK
mv -v /usr/bin/fuser   /bin
mv -v /usr/bin/killall /bin
END_COMMAND_BLOCK

END_BUILD_STEP

#############################

BUILD_STEP@=Procps-ng

ARCHIVE_NAME@=procps-ng-3.3.6.tar.xz

CONFIGURE_COMMAND@=./configure --prefix=/usr --exec-prefix= --libdir=/usr/lib --docdir=/usr/share/doc/procps-ng-3.3.6 --disable-static --disable-skill --disable-kill

MAKE_COMMAND@=make

INSTALL_COMMAND@=make install

BEGIN_COMMAND_BLOCK
mv -v /usr/lib/libprocps.so.* /lib 
ln -sfv ../../lib/libprocps.so.1.1.0 /usr/lib/libprocps.so
END_COMMAND_BLOCK

END_BUILD_STEP

#############################

BUILD_STEP@=E2fsprogs

ARCHIVE_NAME@=e2fsprogs-1.42.7.tar.gz

#Package is to be built in a subdirectory of the source tree:

BEGIN_COMMAND_BLOCK
mkdir -v build
cd build
END_COMMAND_BLOCK

CONFIGURE_COMMAND@=../configure --prefix=/usr --with-root-prefix="" --enable-elf-shlibs --disable-libblkid --disable-libuuid --disable-uuidd --disable-fsck

MAKE_COMMAND@=make -j4

TEST@=make -k check

INSTALL_COMMAND@=make install
INSTALL_COMMAND@=make install-libs

BEGIN_COMMAND_BLOCK
chmod -v u+w /usr/lib/{libcom_err,libe2p,libext2fs,libss}.a

gunzip -v /usr/share/info/libext2fs.info.gz
install-info --dir-file=/usr/share/info/dir /usr/share/info/libext2fs.info

makeinfo -o      doc/com_err.info ../lib/et/com_err.texinfo
install -v -m644 doc/com_err.info /usr/share/info
install-info --dir-file=/usr/share/info/dir /usr/share/info/com_err.info

END_COMMAND_BLOCK

END_BUILD_STEP

#############################

BUILD_STEP@=Shadow

ARCHIVE_NAME@=shadow-4.1.5.1.tar.bz2

BEGIN_COMMAND_BLOCK
sed -i 's/groups$(EXEEXT) //' src/Makefile.in
find man -name Makefile.in -exec sed -i 's/groups\.1 / /' {} \;

sed -i -e 's@#ENCRYPT_METHOD DES@ENCRYPT_METHOD SHA512@' -e 's@/var/spool/mail@/var/mail@' etc/login.defs
END_COMMAND_BLOCK

CONFIGURE_COMMAND@=./configure --sysconfdir=/etc

MAKE_COMMAND@=make -j4

INSTALL_COMMAND@=make install

BEGIN_COMMAND_BLOCK
mv -v /usr/bin/passwd /bin
END_COMMAND_BLOCK

BEGIN_COMMAND_BLOCK
echo "Please now configure shadow for passwords."
pwconv
grpconv
passwd root
END_COMMAND_BLOCK

END_BUILD_STEP

#############################

BUILD_STEP@=Coreutils_2

ARCHIVE_NAME@=coreutils-8.20.tar.xz

BEGIN_COMMAND_BLOCK
patch -Np1 -i ../coreutils-8.20-test_fixes-1.patch
patch -Np1 -i ../coreutils-8.20-i18n-1.patch
END_COMMAND_BLOCK

CONFIGURE_COMMAND@=FORCE_UNSAFE_CONFIGURE=1 ./configure --prefix=/usr --libexecdir=/usr/lib --enable-no-install-program=kill,uptime

MAKE_COMMAND@=make -j4

#Test suites are skipped, as they require su ing into a different user and other complex and unnecessary things

INSTALL_COMMAND@=make install

BEGIN_COMMAND_BLOCK
mv -v /usr/bin/{cat,chgrp,chmod,chown,cp,date,dd,df,echo} /bin
mv -v /usr/bin/{false,ln,ls,mkdir,mknod,mv,pwd,rm} /bin
mv -v /usr/bin/{rmdir,stty,sync,true,uname} /bin
mv -v /usr/bin/chroot /usr/sbin
mv -v /usr/share/man/man1/chroot.1 /usr/share/man/man8/chroot.8
sed -i s/\"1\"/\"8\"/1 /usr/share/man/man8/chroot.8
END_COMMAND_BLOCK

#We move the binaries just incase /usr is not avaible at boot
BEGIN_COMMAND_BLOCK
mv -v /usr/bin/{head,sleep,nice} /bin
END_COMMAND_BLOCK

END_BUILD_STEP

#############################

BUILD_STEP@=Iana_Etc

ARCHIVE_NAME@=iana-etc-2.30.tar.bz2

MAKE_COMMAND@=make

INSTALL_COMMAND@=make install

END_BUILD_STEP

#############################

BUILD_STEP@=M4_2

ARCHIVE_NAME@=m4-1.4.16.tar.bz2

BEGIN_COMMAND_BLOCK
sed -i -e '/gets is a/d' lib/stdio.in.h
END_COMMAND_BLOCK

CONFIGURE_COMMAND@=./configure --prefix=/usr

MAKE_COMMAND@=make -j4

TEST@=sed -i -e '41s/ENOENT/& || errno == EINVAL/' tests/test-readlink.h
TEST@=make check

INSTALL_COMMAND@=make install

END_BUILD_STEP

#############################

BUILD_STEP@=Bison_3

ARCHIVE_NAME@=bison-2.7.tar.xz

CONFIGURE_COMMAND@=./configure --prefix=/usr

BEGIN_COMMAND_BLOCK
echo '#define YYENABLE_NLS 1' >> lib/config.h
END_COMMAND_BLOCK

MAKE_COMMAND@=make -j4

TEST@=make check

INSTALL_COMMAND@=make install

END_BUILD_STEP

#############################

BUILD_STEP@=Grep

ARCHIVE_NAME@=grep-2.14.tar.xz

CONFIGURE_COMMAND@=./configure --prefix=/usr --bindir=/bin

MAKE_COMMAND@=make -j4

TEST@=make check

INSTALL_COMMAND@=make install

END_BUILD_STEP

#############################

BUILD_STEP@=Readline_2

ARCHIVE_NAME@=readline-6.2.tar.gz

BEGIN_COMMAND_BLOCK
sed -i '/MV.*old/d' Makefile.in
sed -i '/{OLDSUFF}/c:' support/shlib-install

patch -Np1 -i ../readline-6.2-fixes-1.patch
END_COMMAND_BLOCK

CONFIGURE_COMMAND@=./configure --prefix=/usr --libdir=/lib

MAKE_COMMAND@=make SHLIB_LIBS=-lncurses

INSTALL_COMMAND@=make install

BEGIN_COMMAND_BLOCK
mv -v /lib/lib{readline,history}.a /usr/lib

rm -v /lib/lib{readline,history}.so
ln -sfv ../../lib/libreadline.so.6 /usr/lib/libreadline.so
ln -sfv ../../lib/libhistory.so.6 /usr/lib/libhistory.so

mkdir   -v       /usr/share/doc/readline-6.2
install -v -m644 doc/*.{ps,pdf,html,dvi} /usr/share/doc/readline-6.2
END_COMMAND_BLOCK

END_BUILD_STEP

#############################

BUILD_STEP@=Bash_2

ARCHIVE_NAME@=bash-4.2.tar.gz

BEGIN_COMMAND_BLOCK
patch -Np1 -i ../bash-4.2-fixes-11.patch
END_COMMAND_BLOCK

CONFIGURE_COMMAND@=./configure --prefix=/usr --bindir=/bin --htmldir=/usr/share/doc/bash-4.2 --without-bash-malloc --with-installed-readline

MAKE_COMMAND@=make -j4

INSTALL_COMMAND@=make install

BEGIN_COMMAND_BLOCK

#Normally we would change to the new bash here, but there's really no good way to do that right now. Subject to change, but for now we just ignore.

echo "Normally we would change to the new bash here, but there's really no good way to do that right now. Subject to change, but for now we just ignore."

END_COMMAND_BLOCK

END_BUILD_STEP

#############################

BUILD_STEP@=Libtool_2

ARCHIVE_NAME@=libtool-2.4.2.tar.gz

CONFIGURE_COMMAND@=./configure --prefix=/usr

MAKE_COMMAND@=make -j4

INSTALL_COMMAND@=make install

END_BUILD_STEP

#############################

BUILD_STEP@=GDBM_2

ARCHIVE_NAME@=gdbm-1.10.tar.gz

CONFIGURE_COMMAND@=./configure --prefix=/usr --enable-libgdbm-compat

MAKE_COMMAND@=make -j4

INSTALL_COMMAND@=make install

END_BUILD_STEP

#############################

BUILD_STEP@=Inetutils

ARCHIVE_NAME@=inetutils-1.9.1.tar.gz

BEGIN_COMMAND_BLOCK
sed -i -e '/gets is a/d' lib/stdio.in.h
END_COMMAND_BLOCK

CONFIGURE_COMMAND@=./configure --prefix=/usr --libexecdir=/usr/sbin --localstatedir=/var --disable-ifconfig --disable-logger --disable-syslogd      --disable-whois  --disable-servers

MAKE_COMMAND@=make -j4

INSTALL_COMMAND@=make install
INSTALL_COMMAND@=make -C doc html
INSTALL_COMMAND@=make -C doc install-html docdir=/usr/share/doc/inetutils-1.9.1

BEGIN_COMMAND_BLOCK
mv -v /usr/bin/{hostname,ping,ping6} /bin
mv -v /usr/bin/traceroute /sbin
END_COMMAND_BLOCK

END_BUILD_STEP

#############################

BUILD_STEP@=Perl_2

ARCHIVE_NAME@=perl-5.16.2.tar.bz2

BEGIN_COMMAND_BLOCK
echo "127.0.0.1 localhost $(hostname)" > /etc/hosts

sed -i -e "s|BUILD_ZLIB\s*= True|BUILD_ZLIB = False|"           \
       -e "s|INCLUDE\s*= ./zlib-src|INCLUDE    = /usr/include|" \
       -e "s|LIB\s*= ./zlib-src|LIB        = /usr/lib|"         \
    cpan/Compress-Raw-Zlib/config.in
END_COMMAND_BLOCK

CONFIGURE_COMMAND@=sh Configure -des -Dprefix=/usr -Dvendorprefix=/usr -Dman1dir=/usr/share/man/man1 -Dman3dir=/usr/share/man/man3 -Dpager="/usr/bin/less -isR" -Duseshrplib

MAKE_COMMAND@=make -j4

INSTALL_COMMAND@=make install

END_BUILD_STEP

#############################

BUILD_STEP@=Autoconf_2

ARCHIVE_NAME@=autoconf-2.69.tar.xz


CONFIGURE_COMMAND@=./configure --prefix=/usr

MAKE_COMMAND@=make -j4

INSTALL_COMMAND@=make install

END_BUILD_STEP

#############################

BUILD_STEP@=Automake

ARCHIVE_NAME@=automake-1.13.1.tar.xz


CONFIGURE_COMMAND@=./configure --prefix=/usr --docdir=/usr/share/doc/automake-1.13.1

MAKE_COMMAND@=make

INSTALL_COMMAND@=make install

END_BUILD_STEP

#############################

BUILD_STEP@=Diffutils

ARCHIVE_NAME@=diffutils-3.2.tar.gz

BEGIN_COMMAND_BLOCK
sed -i -e '/gets is a/d' lib/stdio.in.h
END_COMMAND_BLOCK

CONFIGURE_COMMAND@=./configure --prefix=/usr

MAKE_COMMAND@=make

INSTALL_COMMAND@=make install

END_BUILD_STEP

#############################

BUILD_STEP@=Gawk

ARCHIVE_NAME@=gawk-4.0.2.tar.xz

CONFIGURE_COMMAND@=./configure --prefix=/usr --libexecdir=/usr/lib

MAKE_COMMAND@=make -j4

INSTALL_COMMAND@=make install

BEGIN_COMMAND_BLOCK
mkdir -v /usr/share/doc/gawk-4.0.2
cp    -v doc/{awkforai.txt,*.{eps,pdf,jpg}} /usr/share/doc/gawk-4.0.2
END_COMMAND_BLOCK

END_BUILD_STEP

#############################

BUILD_STEP@=Findutils

ARCHIVE_NAME@=findutils-4.4.2.tar.gz

CONFIGURE_COMMAND@=./configure --prefix=/usr --libexecdir=/usr/lib/findutils --localstatedir=/var/lib/locate

MAKE_COMMAND@=make -j4

INSTALL_COMMAND@=make install

BEGIN_COMMAND_BLOCK
mv -v /usr/bin/find /bin
sed -i 's/find:=${BINDIR}/find:=\/bin/' /usr/bin/updatedb
END_COMMAND_BLOCK

END_BUILD_STEP

#############################

BUILD_STEP@=Flex

ARCHIVE_NAME@=flex-2.5.37.tar.bz2

BEGIN_COMMAND_BLOCK
patch -Np1 -i ../flex-2.5.37-bison-2.6.1-1.patch
END_COMMAND_BLOCK

CONFIGURE_COMMAND@=./configure --prefix=/usr --docdir=/usr/share/doc/flex-2.5.37

MAKE_COMMAND@=make -j4

INSTALL_COMMAND@=make install

BEGIN_COMMAND_BLOCK
ln -sv libfl.a /usr/lib/libl.a

cat > /usr/bin/lex << "EOF"
#!/bin/sh
# Begin /usr/bin/lex

exec /usr/bin/flex -l "$@"

# End /usr/bin/lex
EOF
chmod -v 755 /usr/bin/lex
END_COMMAND_BLOCK

END_BUILD_STEP

#############################

BUILD_STEP@=Gettext

ARCHIVE_NAME@=gettext-0.18.2.tar.gz

CONFIGURE_COMMAND@=./configure --prefix=/usr --docdir=/usr/share/doc/gettext-0.18.2

MAKE_COMMAND@=make -j4

INSTALL_COMMAND@=make install

END_BUILD_STEP

#############################

BUILD_STEP@=Groff

ARCHIVE_NAME@=groff-1.22.1.tar.gz

BEGIN_COMMAND_BLOCK
sed -i -e '163 s/$(DESTDIR)//' contrib/mom/Makefile.sub
END_COMMAND_BLOCK

CONFIGURE_COMMAND@=PAGE=letter ./configure --prefix=/usr

MAKE_COMMAND@=make -j4

BEGIN_COMMAND_BLOCK
mkdir -p /usr/share/doc/groff-1.22/pdf
END_COMMAND_BLOCK

INSTALL_COMMAND@=make install

BEGIN_COMMAND_BLOCK
ln -sv eqn /usr/bin/geqn
ln -sv tbl /usr/bin/gtbl
END_COMMAND_BLOCK

END_BUILD_STEP

#############################

BUILD_STEP@=Xz

ARCHIVE_NAME@=xz-5.0.4.tar.xz

CONFIGURE_COMMAND@=./configure --prefix=/usr --libdir=/lib --docdir=/usr/share/doc/xz-5.0.4

MAKE_COMMAND@=make -j4

INSTALL_COMMAND@=make pkgconfigdir=/usr/lib/pkgconfig install

END_BUILD_STEP

#############################

BUILD_STEP@=GRUB

ARCHIVE_NAME@=grub-2.00.tar.xz

BEGIN_COMMAND_BLOCK
sed -i -e '/gets is a/d' grub-core/gnulib/stdio.in.h
END_COMMAND_BLOCK

CONFIGURE_COMMAND@=./configure --prefix=/usr --sysconfdir=/etc --disable-grub-emu-usb --disable-efiemu --disable-werror

MAKE_COMMAND@=make -j4

INSTALL_COMMAND@=make install

END_BUILD_STEP

#############################

BUILD_STEP@=Less

ARCHIVE_NAME@=less-451.tar.gz

CONFIGURE_COMMAND@=./configure --prefix=/usr --sysconfdir=/etc

MAKE_COMMAND@=make -j4

INSTALL_COMMAND@=make install

END_BUILD_STEP

#############################

BUILD_STEP@=Gzip

ARCHIVE_NAME@=gzip-1.5.tar.xz

CONFIGURE_COMMAND@=./configure --prefix=/usr --bindir=/bin

MAKE_COMMAND@=make -j4

INSTALL_COMMAND@=make install

BEGIN_COMMAND_BLOCK
mv -v /bin/{gzexe,uncompress,zcmp,zdiff,zegrep} /usr/bin
mv -v /bin/{zfgrep,zforce,zgrep,zless,zmore,znew} /usr/bin
END_COMMAND_BLOCK

END_BUILD_STEP

#############################

BUILD_STEP@=IPRoute2

ARCHIVE_NAME@=iproute2-3.7.0.tar.xz

BEGIN_COMMAND_BLOCK
sed -i '/^TARGETS/s@arpd@@g' misc/Makefile
sed -i /ARPD/d Makefile
sed -i 's/arpd.8//' man/man8/Makefile
END_COMMAND_BLOCK

MAKE_COMMAND@=make DESTDIR=

INSTALL_COMMAND@=make DESTDIR= MANDIR=/usr/share/man DOCDIR=/usr/share/doc/iproute2-3.7.0 install

END_BUILD_STEP

#############################

BUILD_STEP@=Kbd

ARCHIVE_NAME@=kbd-1.15.5.tar.gz

BEGIN_COMMAND_BLOCK

patch -Np1 -i ../kbd-1.15.5-backspace-1.patch

sed -i -e '326 s/if/while/' src/loadkeys.analyze.l

END_COMMAND_BLOCK

CONFIGURE_COMMAND@=./configure --prefix=/usr --datadir=/lib/kbd --disable-vlock

MAKE_COMMAND@=make -j4

INSTALL_COMMAND@=make install

BEGIN_COMMAND_BLOCK
mv -v /usr/bin/{kbd_mode,loadkeys,openvt,setfont} /bin

mkdir -v /usr/share/doc/kbd-1.15.5
cp -R -v doc/* /usr/share/doc/kbd-1.15.5
END_COMMAND_BLOCK

END_BUILD_STEP

#############################

BUILD_STEP@=Kmod

ARCHIVE_NAME@=kmod-12.tar.xz

CONFIGURE_COMMAND@=./configure --prefix=/usr --bindir=/bin --libdir=/lib --sysconfdir=/etc --disable-manpages --with-xz --with-zlib

MAKE_COMMAND@=make -j4

INSTALL_COMMAND@=make pkgconfigdir=/usr/lib/pkgconfig install

BEGIN_COMMAND_BLOCK
for target in depmod insmod modinfo modprobe rmmod; do
  ln -sv ../bin/kmod /sbin/$target
done

ln -sv kmod /bin/lsmod
END_COMMAND_BLOCK

END_BUILD_STEP

#############################

BUILD_STEP@=Libpipeline

ARCHIVE_NAME@=libpipeline-1.2.2.tar.gz

CONFIGURE_COMMAND@=PKG_CONFIG_PATH=/tools/lib/pkgconfig ./configure --prefix=/usr

MAKE_COMMAND@=make -j4

INSTALL_COMMAND@=make install

END_BUILD_STEP

#############################

BUILD_STEP@=Make_2

ARCHIVE_NAME@=make-3.82.tar.bz2

BEGIN_COMMAND_BLOCK
patch -Np1 -i ../make-3.82-upstream_fixes-3.patch
END_COMMAND_BLOCK

CONFIGURE_COMMAND@=./configure --prefix=/usr

MAKE_COMMAND@=make -j4

INSTALL_COMMAND@=make install

END_BUILD_STEP

#############################

BUILD_STEP@=Man_DB_2

ARCHIVE_NAME@=man-db-2.6.3.tar.xz

CONFIGURE_COMMAND@=./configure --prefix=/usr --libexecdir=/usr/lib --docdir=/usr/share/doc/man-db-2.6.3 --sysconfdir=/etc --disable-setuid --with-browser=/usr/bin/lynx --with-vgrind=/usr/bin/vgrind --with-grap=/usr/bin/grap

MAKE_COMMAND@=make -j4

INSTALL_COMMAND@=make install

END_BUILD_STEP

#############################

BUILD_STEP@=Patch_2

ARCHIVE_NAME@=patch-2.7.1.tar.xz

CONFIGURE_COMMAND@=./configure --prefix=/usr

MAKE_COMMAND@=make -j4

INSTALL_COMMAND@=make install

END_BUILD_STEP

#############################

BUILD_STEP@=Sysklogd

ARCHIVE_NAME@=sysklogd-1.5.tar.gz

MAKE_COMMAND@=make

INSTALL_COMMAND@=make BINDIR=/sbin install

BEGIN_COMMAND_BLOCK
cat > /etc/syslog.conf << "EOF"
# Begin /etc/syslog.conf

auth,authpriv.* -/var/log/auth.log
*.*;auth,authpriv.none -/var/log/sys.log
daemon.* -/var/log/daemon.log
kern.* -/var/log/kern.log
mail.* -/var/log/mail.log
user.* -/var/log/user.log
*.emerg *

# End /etc/syslog.conf
EOF
END_COMMAND_BLOCK

END_BUILD_STEP

#############################

BUILD_STEP@=Sysvinit

ARCHIVE_NAME@=sysvinit-2.88dsf.tar.bz2

BEGIN_COMMAND_BLOCK
sed -i 's@Sending processes@& configured via /etc/inittab@g' src/init.c

sed -i -e '/utmpdump/d' -e '/mountpoint/d' src/Makefile
END_COMMAND_BLOCK

MAKE_COMMAND@=make -C src

INSTALL_COMMAND@=make -C src install

END_BUILD_STEP

#############################

BUILD_STEP@=Tar

ARCHIVE_NAME@=tar-1.26.tar.bz2

BEGIN_COMMAND_BLOCK
sed -i -e '/gets is a/d' gnu/stdio.in.h
END_COMMAND_BLOCK

CONFIGURE_COMMAND@=FORCE_UNSAFE_CONFIGURE=1 ./configure --prefix=/usr --bindir=/bin --libexecdir=/usr/sbin

MAKE_COMMAND@=make -j4

INSTALL_COMMAND@=make install
INSTALL_COMMAND@=make -C doc install-html docdir=/usr/share/doc/tar-1.26

END_BUILD_STEP

#############################

BUILD_STEP@=Texinfo

ARCHIVE_NAME@=texinfo-4.13a.tar.gz

#don't know why extracted archive is of a different name
BEGIN_COMMAND_BLOCK
cd texinfo-4.13
END_COMMAND_BLOCK

CONFIGURE_COMMAND@=./configure --prefix=/usr

MAKE_COMMAND@=make

INSTALL_COMMAND@=make install

BEGIN_COMMAND_BLOCK
cd ..
rm -rf texinfo-4.13
END_COMMAND_BLOCK

END_BUILD_STEP

#############################

BUILD_STEP@=Udev_196

ARCHIVE_NAME@=systemd-196.tar.xz

BEGIN_COMMAND_BLOCK
tar -xvf ../udev-lfs-196-4.tar.bz2

sed -i -e 's/create/update/' src/udev/udevadm-hwdb.c
END_COMMAND_BLOCK

MAKE_COMMAND@=make -f udev-lfs-196-4/Makefile.lfs

INSTALL_COMMAND@=make -f udev-lfs-196-4/Makefile.lfs install

BEGIN_COMMAND_BLOCK
build/udevadm hwdb --update

bash udev-lfs-196-4/init-net-rules.sh
END_COMMAND_BLOCK

END_BUILD_STEP

#############################

BUILD_STEP@=Vim

ARCHIVE_NAME@=vim-7.3.tar.bz2

BEGIN_COMMAND_BLOCK
cd vim73
echo '#define SYS_VIMRC_FILE "/etc/vimrc"' >> src/feature.h
END_COMMAND_BLOCK

CONFIGURE_COMMAND@=./configure --prefix=/usr --enable-multibyte

MAKE_COMMAND@=make -j4

INSTALL_COMMAND@=make install

BEGIN_COMMAND_BLOCK
ln -sv vim /usr/bin/vi
for L in  /usr/share/man/{,*/}man1/vim.1; do
    ln -sv vim.1 $(dirname $L)/vi.1
done

ln -sv ../vim/vim73/doc /usr/share/doc/vim-7.3

cat > /etc/vimrc << "EOF"
" Begin /etc/vimrc

set nocompatible
set backspace=2
syntax on
if (&term == "iterm") || (&term == "putty")
  set background=dark
endif

" End /etc/vimrc
EOF

cd ..
rm -rf vim73
END_COMMAND_BLOCK

END_BUILD_STEP

#############################


BUILD_STEP@=NetworkSetup

ONLY_COMMANDS@=True

BEGIN_COMMAND_BLOCK

#This is a sample Network Interface Configuration FIle, will need one for each interface ending in a meaningful extention and starting with ifconfig. (ifconfig.eth0)

cd /etc/sysconfig/
cat > ifconfig.eth0 << "EOF"
ONBOOT=yes
IFACE=eth0
SERVICE=ipv4-static
IP=192.168.1.1
GATEWAY=192.168.1.2
PREFIX=24
BROADCAST=192.168.1.255
EOF



cat > /etc/resolv.conf << "EOF"
# Begin /etc/resolv.conf

#Using Google's DNS servers

#domain <Your Domain Name>
nameserver 8.8.8.8
nameserver 8.8.4.4

# End /etc/resolv.conf
EOF

cat > /etc/hosts << "EOF"
# Begin /etc/hosts (network card version)

127.0.0.1 localhost
192.168.0.1 LBS_LFS.example.org LBS_LFS localhost

# End /etc/hosts (network card version)
EOF

END_COMMAND_BLOCK

END_BUILD_STEP

#############################

BUILD_STEP@=LFS_Bootscripts

ARCHIVE_NAME@=lfs-bootscripts-20130123.tar.bz2

INSTALL_COMMAND@=make install

END_BUILD_STEP

#############################

BUILD_STEP@=StartupSetup

ONLY_COMMANDS@=True

BEGIN_COMMAND_BLOCK

cat > /etc/inittab << "EOF"
# Begin /etc/inittab

id:3:initdefault:

si::sysinit:/etc/rc.d/init.d/rc S

l0:0:wait:/etc/rc.d/init.d/rc 0
l1:S1:wait:/etc/rc.d/init.d/rc 1
l2:2:wait:/etc/rc.d/init.d/rc 2
l3:3:wait:/etc/rc.d/init.d/rc 3
l4:4:wait:/etc/rc.d/init.d/rc 4
l5:5:wait:/etc/rc.d/init.d/rc 5
l6:6:wait:/etc/rc.d/init.d/rc 6

ca:12345:ctrlaltdel:/sbin/shutdown -t1 -a -r now

su:S016:once:/sbin/sulogin

1:2345:respawn:/sbin/agetty --noclear tty1 9600
2:2345:respawn:/sbin/agetty tty2 9600
3:2345:respawn:/sbin/agetty tty3 9600
4:2345:respawn:/sbin/agetty tty4 9600
5:2345:respawn:/sbin/agetty tty5 9600
6:2345:respawn:/sbin/agetty tty6 9600

# End /etc/inittab
EOF

echo "HOSTNAME=LBS_LFS" > /etc/sysconfig/network

cat > /etc/sysconfig/clock << "EOF"
# Begin /etc/sysconfig/clock

UTC=1

# Set this to any options you might need to give to hwclock, 
# such as machine hardware clock type for Alphas.
CLOCKPARAMS=

# End /etc/sysconfig/clock
EOF


END_COMMAND_BLOCK

END_BUILD_STEP

#############################

BUILD_STEP@=MiscSetup

ONLY_COMMANDS@=True

BEGIN_COMMAND_BLOCK

#This is where the linux console commands go, set by the console bootscript

#This is where the sysklogd script would be configured

cat > /etc/profile << "EOF"
# Begin /etc/profile

export LANG=en_US.UTF-8

# End /etc/profile
EOF

cat > /etc/inputrc << "EOF"
# Begin /etc/inputrc
# Modified by Chris Lynn <roryo@roryo.dynup.net>

# Allow the command prompt to wrap to the next line
set horizontal-scroll-mode Off

# Enable 8bit input
set meta-flag On
set input-meta On

# Turns off 8th bit stripping
set convert-meta Off

# Keep the 8th bit for display
set output-meta On

# none, visible or audible
set bell-style none

# All of the following map the escape sequence of the value
# contained in the 1st argument to the readline specific functions
"\eOd": backward-word
"\eOc": forward-word

# for linux console
"\e[1~": beginning-of-line
"\e[4~": end-of-line
"\e[5~": beginning-of-history
"\e[6~": end-of-history
"\e[3~": delete-char
"\e[2~": quoted-insert

# for xterm
"\eOH": beginning-of-line
"\eOF": end-of-line

# for Konsole
"\e[H": beginning-of-line
"\e[F": end-of-line

# End /etc/inputrc
EOF

END_COMMAND_BLOCK

END_BUILD_STEP

#############################

BUILD_STEP@=StartupSetup

ONLY_COMMANDS@=True

BEGIN_COMMAND_BLOCK

cat > /etc/fstab << "EOF"
# Begin /etc/fstab

# file system  mount-point  type     options             dump  fsck
#                                                              order

/dev/sda3      /            ext3    defaults            1     1
#/dev/<yyy>     swap         swap     pri=1               0     0
proc           /proc        proc     nosuid,noexec,nodev 0     0
sysfs          /sys         sysfs    nosuid,noexec,nodev 0     0
devpts         /dev/pts     devpts   gid=5,mode=620      0     0
tmpfs          /run         tmpfs    defaults            0     0
devtmpfs       /dev         devtmpfs mode=0755,nosuid    0     0

# End /etc/fstab
EOF

vim /etc/fstab

END_COMMAND_BLOCK

END_BUILD_STEP

#############################


BUILD_STEP@=Linux_Kernel

ARCHIVE_NAME@=linux-3.7.4.tar.xz

BEGIN_COMMAND_BLOCK
make mrproper
make defconfig
END_COMMAND_BLOCK

CONFIGURE_COMMAND@=make LANG=en_US.UTF-8 LC_ALL= menuconfig

BEGIN_COMMAND_BLOCK
cp .config ../../linux_kernel.config
END_COMMAND_BLOCK

MAKE_COMMAND@=make -j4

#install modules, if applicable
INSTALL_COMMAND@=make modules_install

BEGIN_COMMAND_BLOCK
cp -v arch/x86/boot/bzImage /boot/vmlinuz-3.7.4-lfs-SVN-20130127

cp -v System.map /boot/System.map-3.7.4

cp -v .config /boot/config-3.7.4

install -d /usr/share/doc/linux-3.7.4
cp -r Documentation/* /usr/share/doc/linux-3.7.4

chown -R 0:0 ../linux-3.7.4

install -v -m755 -d /etc/modprobe.d
cat > /etc/modprobe.d/usb.conf << "EOF"
# Begin /etc/modprobe.d/usb.conf

install ohci_hcd /sbin/modprobe ehci_hcd ; /sbin/modprobe -i ohci_hcd ; true
install uhci_hcd /sbin/modprobe ehci_hcd ; /sbin/modprobe -i uhci_hcd ; true

# End /etc/modprobe.d/usb.conf
EOF

END_COMMAND_BLOCK

END_BUILD_STEP

#############################

BUILD_STEP@=GRUB_setup

ONLY_COMMANDS@=True

BEGIN_COMMAND_BLOCK

#Do nothing for now. This really needs to be manual.
echo "Not doing any grub setup, this really needs to be manual."

END_COMMAND_BLOCK

END_BUILD_STEP

#############################

BUILD_STEP@=LFS_Final

ONLY_COMMANDS@=True

BEGIN_COMMAND_BLOCK

echo SVN-20130127 > /etc/lfs-release

cat > /etc/lsb-release << "EOF"
DISTRIB_ID="LinuxBuildSystem - Linux From Scratch"
DISTRIB_RELEASE="SVN-20130127"
DISTRIB_CODENAME="LinuxBuildSystem's LFS Build"
DISTRIB_DESCRIPTION="Linux From Scratch, built with the LinuxBuildSystem"
EOF

echo "Would unmount stuff now, but why not just reboot now."

END_COMMAND_BLOCK

END_BUILD_STEP

#############################


